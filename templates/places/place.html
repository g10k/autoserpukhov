{% extends "base.html" %}
{% load threadedcomments_tags %}
{% load comments %}
{% load static %}
{% load staticfiles %}
{% load loginza_widget %}
{% load ratings %}

{% block title %}{{ title }}{% endblock%}
{% block extrastyle %}
    <link href='{% static "css/jquery.rating.css" %}' rel='stylesheet'>
{% endblock %}
{% block extrahead %}
    <script src={% static "js/jquery.rating.js" %}></script>
    <script>
        $(function(){
            $(".star").rating();
            $("#new_otzyv_form").hide();
            $("#new_otzyv").click(function(){
                $("#new_otzyv_form").show();
            })
        })
    </script>
{% endblock %}
{% block content %}
    <h1>Описание местечка</h1>
    <h2>{{ autocenter }}, {{ autocenter.address }}</h2>
    <p>Теги:{% for tag  in autocenter.maintenance.all %}<a href="#">{{ tag }}</a>{% endfor %}</p>
    <p>Голосов:{{ autocenter.kachestvo.votes }}, набрано баллов {{ autocenter.kachestvo.score }}</p>

    {{ autocenter.about }}
    <button class="btn" id='new_otzyv'>Оставить отзыв</button>
    <h4> Отзывы</h4>

    {% if user.is_authenticated %}
        <form id='new_otzyv_form' method="post" action="">{% csrf_token %}
            <table>
                {{ otzyvForm.as_table }}
                {{ oztyvForm.errors }}
            </table>
            <input type="submit" value="Отправить отзыв">
        </form>
    {% else %}
        <p>Оставить отзыв:{% loginza_button "Чтобы оставить отзыв авторизируйтесь через соц сети"  %}</p>
    {% endif %}

    {% for otzyv in autocenter.otzyv_set.all %}
        <h3>{{ otzyv.user }} оставил отзыв</h3>

        <div class='well'>{{ otzyv }}</div>
        {% render_comments otzyv %}
        <a href="#">Комментировать</a>


        {% if user.is_authenticated %}
            <h4>Комментарии к отзыву {{ otzyv.user }}</h4>
        {% get_comment_form for otzyv as form %}
        <table>
            <form action="/comments/post/" method="post">{% csrf_token %}
                {{ form }}
                <tr>
                    <td colspan="2">
                        <input type="hidden" name="next" value="{{ autocenter.get_absolute_url }}" />
                        <input type="submit" name="submit" value="Отправить">
{#                        <input type="submit" name="preview" value="Preview">#}
                    </td>
                </tr>
            </form>
            {% rating_by_request request on instance.field as could_vote %}

{#            {% with autocenter.udobstvo.get_rating_for_user(request.user) as could_vote  %}#}
                {% if could_vote  %}
                    Можешь проголосвать
                {% else %}
                    Уже голосовал
                {% endif %}
{#            {% endwith %}#}
            <a name="new_comment"></a>
        </table>
    {% else %}
       <p>Оставить отзыв:{% loginza_button "Чтобы оставить отзыв авторизируйтесь через соц сети"  %}</p>
    {% endif %}

    {% endfor %}

    <div id="mc-container"></div>
    <script type="text/javascript">
        var mcSite = '16449';
        (function() {
            var mc = document.createElement('script');
            mc.type = 'text/javascript';
            mc.async = true;
            mc.src = 'http://cackle.me/mc.widget-min.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(mc);
        })();
    </script>
    <a href="http://cackle.me" id="mc-link">система комментирования <b style="color:#4FA3DA">CACKL</b><b style="color:#F65077">E</b></a>
{#    {% get_comment_list for autocenter as comment_list%}#}
{##}
{##}
{##}
{##}
{##}
{##}
{##}
{#    {% for comment in comment_list|fill_tree|annotate_tree %}#}
{#        {% place_comment comment %}#}
{#    {% endfor %}#}
{#    {% get_comment_form for autocenter as form %}#}
{##}
{#    <table>#}
{#        <a name="new_comment"></a>#}
{#        <form action="/comments/post/" method="post">{% csrf_token %}#}
{#            {{ form }}#}
{#            <tr>#}
{#                <td colspan="2">#}
{#                    <input type="hidden" name="next" value="{{ autocenter.get_absolute_url }}" />#}
{#                    <input type="submit" name="submit" value="Post">#}
{#                    <input type="submit" name="preview" value="Preview">#}
{#                </td>#}
{#            </tr>#}
{#        </form>#}
{#    </table>#}
{##}


{% endblock %}